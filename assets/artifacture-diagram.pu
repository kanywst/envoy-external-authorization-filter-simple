@startuml
!theme toy

title Envoy + OPA Authorization PoC Architecture ðŸ›¡ï¸

skinparam backgroundcolor #f7f7ff
skinparam defaultFontName "Arial"
skinparam node {
  BorderColor #4477aa
  BackgroundColor #ddeeff
}
skinparam component {
  BorderColor #4477aa
  BackgroundColor #ffffff
}
skinparam interface {
  BorderColor #66bb66
  BackgroundColor #eeffee
}

' =========================================================
frame "Kubernetes Cluster" as KubeCluster {

  actor Client as "Client\nRequest"

  node "Envoy Pod" as EnvoyPodNode {
    component "Envoy Proxy" as Envoy {
      port "8080 (HTTP)" as P_Envoy
      component "HTTP Connection Manager" as HCM
      component "ExtAuthz Filter" as ExtAuthz
      component "Router Filter" as Router
      
      HCM --> ExtAuthz : Internal
      ExtAuthz --> Router : If Allowed
    }
  }

  node "OPA Pod" as OPAPodNode {
    component "OPA Engine" as OPA {
      port "9191 (gRPC)" as P_OPA_gRPC
      port "8181 (HTTP)" as P_OPA_HTTP
      file "Rego Policy" as Rego
      
      OPA -down-> Rego : Evaluates
    }
  }

  node "Echo Server Pod" as EchoPodNode {
    component "Echo Server" as Echo {
      port "80 (HTTP)" as P_Echo
    }
  }

  ' =========================================================
  ' Traffic Flow
  ' =========================================================
  
  ' 1. Client to Envoy
  Client --> P_Envoy : HTTP Request
  P_Envoy --> HCM

  ' 2. Authorization Flow (gRPC)
  ExtAuthz -right-> P_OPA_gRPC : **1. CheckRequest (gRPC)**
  P_OPA_gRPC --> OPA

  ' 3. Upstream Routing
  Router -down-> P_Echo : **2. Upstream (Authorized)**
  
  ' 4. Direct OPA Access (Optional based on your Rego)
  Router .right.> P_OPA_HTTP : **(Optional) /v1/data**
  
}
@enduml
