@startuml
title Envoy/OPA Authorization Sequence Flow (Logic Evaluation)

' Participant Definitions
participant C as Client
participant E as "Envoy Proxy"
participant O as "OPA Engine"
participant S as "Echo Server"

activate C
C -> E: **HTTP Request**\n(GET /api/user, Authorization: Bearer ...)
deactivate C

activate E
E -> E: HTTP Connection Manager\nExtract headers & path

' Authorization Request
E -> O: **ExtAuthz: CheckRequest (gRPC)**\ninput.attributes.request...
deactivate E

activate O
group Policy Evaluation (Rego)
    note right of O
        **Logic: OR (Short-circuit)**
        Any rule returning true grants access.
    end note
    
    O -> O: 1. Check **default allow** (false)
    loop Evaluate "allow" rules
        O -> O: Rule A: Check **Bearer Token**?
        O -> O: Rule B: Check **Admin Token**?
        O -> O: Rule C: Check **Public Path**?
    end
    note right of O
        If **any** rule matches -> **Allow**
        Else -> **Deny**
    end note
end

O --> E: **CheckResponse** (Allowed/Denied)
deactivate O

activate E
alt Status: Allowed (allow == true)
    E -> E: Router Filter
    E -> S: **Forward Request**
    deactivate E

    activate S
    S --> E: HTTP Response (200 OK)
    deactivate S

    activate E
    E --> C: HTTP Response
    deactivate E
else Status: Denied (allow == false)
    E -> C: **HTTP 403 Forbidden**
    deactivate E
end

@enduml
